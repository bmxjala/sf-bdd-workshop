machine:
  services:
    - docker
    - mongodb
  php:
    version: 5.5.11
  node:
    version: 5.1.0
  hosts:
    sf-bdd-mail-service-qa: 46.101.223.130

dependencies:
  pre:
    - sudo service mongodb stop
    - printf "\n" | pecl install mongo
    - cd sf-bdd-mail-service && composer install -n && npm install bower && npm install gulp -g && bower install && npm install && gulp dist
  override:
    - sudo pip install -U docker-compose==1.3.3
    - docker-compose up -d

test:
  override:
    - sudo lxc-attach -n "$(docker inspect --format '{{.Id}}' workshop_php_1)" -- bash -c "cd /var/www/sf-bdd-mail-service && composer install -n"
    - sudo lxc-attach -n "$(docker inspect --format '{{.Id}}' workshop_php_1)" -- bash -c "chown -R www-data:www-data /tmp"
    - sudo lxc-attach -n "$(docker inspect --format '{{.Id}}' workshop_php_1)" -- bash -c "cd /var/www/sf-bdd-mail-service && php app/console sf-bdd:workshop:theme:create --name=Default --default=true --content='<html><body><div>{{main}}</div></body></html>'"
    - sudo lxc-attach -n "$(docker inspect --format '{{.Id}}' workshop_php_1)" -- bash -c "cd /var/www/sf-bdd-mail-service && ./bin/behat"
    - sudo lxc-attach -n "$(docker inspect --format '{{.Id}}' workshop_php_1)" -- bash -c "chown -R www-data:www-data /tmp"
    - sudo lxc-attach -n "$(docker inspect --format '{{.Id}}' workshop_php_1)" -- bash -c "cd /var/www/sf-bdd-mail-service && ./bin/behat --config behat-selenium.yml"
    - sudo lxc-attach -n "$(docker inspect --format '{{.Id}}' workshop_php_1)" -- bash -c "cd /var/www/sf-bdd-mail-service && ./bin/phpspec run -fpretty"

deployment:
  FEATURE:
    branch: /\d*_.*/
    commands:
      - sudo docker commit "$(docker inspect --format '{{.Id}}' workshop_php_1)" quay.io/sf-bdd/mail-service-php-dist:$CIRCLE_BUILD_NUM-php-feature
      - sudo docker login -e="." -u="$QUAY_USER" -p="$QUAY_PASS" quay.io
      - sudo docker push quay.io/sf-bdd/mail-service-php-dist:$CIRCLE_BUILD_NUM-php-feature

  QA:
    branch: develop
    commands:
      - sudo docker commit "$(docker inspect --format '{{.Id}}' workshop_php_1)" quay.io/sf-bdd/mail-service-php-dist:$CIRCLE_BUILD_NUM-php-qa
      - sudo docker login -e="." -u="$QUAY_USER" -p="$QUAY_PASS" quay.io
      - sudo docker push quay.io/sf-bdd/mail-service-php-dist:$CIRCLE_BUILD_NUM-php-qa
      - ssh root@sf-bdd-mail-service-qa sh pull_images.sh $CIRCLE_BUILD_NUM
      - ssh root@sf-bdd-mail-service-qa sh deploy.sh $CIRCLE_BUILD_NUM
